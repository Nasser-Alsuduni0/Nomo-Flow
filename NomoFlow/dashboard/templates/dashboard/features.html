{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Features - NomoFlow{% endblock %}
{% block header %}Nomo Flow Features{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="mb-4">
        <h2 class="mb-2" style="font-weight: 700; color: var(--text);">Nomo Flow Features</h2>
        <p class="text-muted mb-0" style="font-size: 1rem;">Enable the features you need in your store and customize them according to your needs.</p>
    </div>

    <div class="row g-4">
        {% for feature in features %}
        <div class="col-lg-4 col-md-6">
            <div class="card h-100 border-0 shadow-sm" style="transition: all 0.3s ease;">
                <div class="card-body p-4 d-flex flex-column">
                    <!-- Icon and Toggle -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 48px; height: 48px; background-color: {{ feature.icon_color }}20;">
                                <i class="{{ feature.icon }} fs-4" style="color: {{ feature.icon_color }};"></i>
                            </div>
                        </div>
                        <!-- Toggle Switch -->
                        <div class="form-check form-switch">
                            <input class="form-check-input feature-toggle" 
                                   type="checkbox" 
                                   id="toggle-{{ feature.key }}"
                                   data-feature="{{ feature.key }}"
                                   {% if feature.is_enabled %}checked{% endif %}
                                   style="width: 3rem; height: 1.5rem; cursor: pointer;">
                        </div>
                    </div>

                    <!-- Title -->
                    <h5 class="card-title mb-2" style="font-weight: 600; color: var(--text);">
                        {{ feature.title }}
                        {% if not feature.is_ready and not feature.is_enabled %}
                        <span class="badge bg-warning text-dark ms-2" style="font-size: 0.7rem; font-weight: 500;">
                            Setup Required
                        </span>
                        {% endif %}
                    </h5>

                    <!-- Description -->
                    <p class="card-text text-muted mb-4 flex-grow-1" style="font-size: 0.9rem; line-height: 1.6;">
                        {{ feature.description }}
                        {% if not feature.is_ready and not feature.is_enabled %}
                        <br><small class="text-warning" style="font-weight: 500;">
                            <i class="bi bi-info-circle me-1"></i>Create your first {{ feature.title|lower }} to enable this feature.
                        </small>
                        {% endif %}
                    </p>

                    <!-- Settings Link -->
                    <div class="mt-auto">
                        <a href="{{ feature.settings_url }}" 
                           class="text-decoration-none d-flex align-items-center" 
                           style="color: var(--brand); font-weight: 500; font-size: 0.9rem;">
                            <i class="bi bi-gear me-2"></i>
                            Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggles = document.querySelectorAll('.feature-toggle');
    
    toggles.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const featureKey = this.dataset.feature;
            const isEnabled = this.checked;
            
            // Disable toggle while processing
            this.disabled = true;
            
            // Send toggle request
            fetch('/features/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    feature: featureKey,
                    enabled: isEnabled
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showNotification(data.message, 'success');
                } else {
                    // Revert toggle on error
                    this.checked = !isEnabled;
                    
                    // If feature requires setup, show special message with link
                    if (data.requires_setup && data.settings_url) {
                        showSetupRequiredNotification(data.message, data.settings_url);
                    } else {
                        showNotification(data.message || 'Failed to toggle feature', 'error');
                    }
                }
            })
            .catch(error => {
                // Revert toggle on error
                this.checked = !isEnabled;
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Error:', error);
            })
            .finally(() => {
                // Re-enable toggle
                this.disabled = false;
            });
        });
    });
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Helper function to show notifications
function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Helper function to show setup required notification with link
function showSetupRequiredNotification(message, settingsUrl) {
    // Create notification element with button
    const notification = document.createElement('div');
    notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px;';
    notification.innerHTML = `
        <div class="d-flex align-items-start">
            <i class="bi bi-exclamation-triangle-fill me-2 mt-1" style="font-size: 1.2rem;"></i>
            <div class="flex-grow-1">
                <strong>Setup Required</strong>
                <p class="mb-2 mt-1">${message}</p>
                <a href="${settingsUrl}" class="btn btn-sm btn-warning">
                    <i class="bi bi-gear me-1"></i> Go to Settings
                </a>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 8 seconds (longer for setup messages)
    setTimeout(() => {
        notification.remove();
    }, 8000);
}
</script>

<style>
.feature-toggle:checked {
    background-color: var(--brand);
    border-color: var(--brand);
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12) !important;
}

.form-check-input:focus {
    border-color: var(--brand);
    box-shadow: 0 0 0 0.25rem rgba(23, 168, 255, 0.25);
}
</style>
{% endblock %}

