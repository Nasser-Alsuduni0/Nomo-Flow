{% extends 'dashboard/base.html' %}
{% block title %}Dashboard · Overview{% endblock %}
{% block header %}Overview{% endblock %}
{% block content %}

<div class="alert alert-info mb-3" role="alert">
  <i class="bi bi-shop me-2"></i>
  <strong>Current Store:</strong> {{ merchant.name }} ({{ merchant.salla_merchant_id }})
</div>

<!-- KPI Cards -->
<div class="row g-3 mb-4">
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="card h-100">
      <div class="card-body p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small mb-1">Spend Today</div>
            <div id="kpi-spend" class="fs-4 fw-bold text-primary">-</div>
          </div>
          <div class="text-primary">
            <i class="bi bi-currency-dollar fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="card h-100">
      <div class="card-body p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small mb-1">Conversions</div>
            <div id="kpi-conv" class="fs-4 fw-bold text-success">-</div>
          </div>
          <div class="text-success">
            <i class="bi bi-graph-up fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="card h-100">
      <div class="card-body p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small mb-1">CPA</div>
            <div id="kpi-cpa" class="fs-4 fw-bold text-warning">-</div>
          </div>
          <div class="text-warning">
            <i class="bi bi-calculator fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="card h-100">
      <div class="card-body p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small mb-1">ROAS</div>
            <div id="kpi-roas" class="fs-4 fw-bold text-info">-</div>
          </div>
          <div class="text-info">
            <i class="bi bi-percent fs-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Campaign Management -->
<div class="row g-3 mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Campaign Management</h6>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
            <i class="bi bi-plus-circle me-1"></i>Create Campaign
          </button>
        </div>
      </div>
      <div class="card-body">
        <!-- Campaign Filters -->
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button class="btn btn-outline-secondary btn-sm" data-filter="running">
            <i class="bi bi-play-circle me-1"></i>Active <span id="count-active" class="badge bg-success ms-1">0</span>
          </button>
          <button class="btn btn-outline-secondary btn-sm" data-filter="paused">
            <i class="bi bi-pause-circle me-1"></i>Paused <span id="count-paused" class="badge bg-warning ms-1">0</span>
          </button>
          <button class="btn btn-outline-secondary btn-sm" data-filter="draft">
            <i class="bi bi-file-earmark me-1"></i>Draft <span id="count-draft" class="badge bg-secondary ms-1">0</span>
          </button>
          <button class="btn btn-outline-secondary btn-sm" data-filter="">
            <i class="bi bi-list me-1"></i>All
          </button>
        </div>
        
        <!-- Campaigns Table -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Campaign</th>
                <th>Objective</th>
                <th>Channel</th>
                <th>Status</th>
                <th class="text-end">Budget</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="campaigns-body">
              <tr>
                <td colspan="6" class="text-center text-muted">Loading campaigns...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Performance Chart -->
<div class="row g-3 mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Performance — Last 7 Days</h6>
      </div>
      <div class="card-body">
        <canvas id="perfChart" height="100"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Create Campaign Modal -->
<div class="modal fade" id="createCampaignModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Campaign</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="createCampaignForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Campaign Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Objective</label>
            <select class="form-select" name="objective" required>
              <option value="">Select objective</option>
              <option value="conversions">Conversions</option>
              <option value="traffic">Traffic</option>
              <option value="awareness">Awareness</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Primary Channel</label>
            <select class="form-select" name="primary_channel" required>
              <option value="">Select channel</option>
              <option value="tiktok">TikTok</option>
              <option value="snapchat">Snapchat</option>
              <option value="instagram">Instagram</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Daily Budget (USD)</label>
            <input type="number" class="form-control" name="budget_daily" min="1" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Campaign</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const apiBase = "/api/marketing";

  function money(v){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(v||0); }
  function badge(status){
    if(status==="running") return '<span class="badge bg-success">Active</span>';
    if(status==="paused")  return '<span class="badge bg-warning">Paused</span>';
    if(status==="draft")   return '<span class="badge bg-secondary">Draft</span>';
    return `<span class="badge bg-light text-dark">${status||"-"}</span>`;
  }
  function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m?m.pop():'';
  }
  const csrftoken=getCookie('csrftoken');

  async function loadKPIs(){
    try{
      const r = await fetch(`${apiBase}/kpis/`);
      const d = await r.json();
      document.getElementById("kpi-spend").textContent = money(d.spend_today||0);
      document.getElementById("kpi-conv").textContent  = d.conversions ?? 0;
      document.getElementById("kpi-cpa").textContent   = d.cpa ?? "-";
      document.getElementById("kpi-roas").textContent  = d.roas ?? "-";
    }catch(e){ console.warn(e); }
  }

  async function loadCampaigns(filter=null){
    const body = document.getElementById("campaigns-body");   
    body.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Loading…</td></tr>`;

    try{
      const r = await fetch(`${apiBase}/campaigns/`);
      let list = await r.json();
      if(filter){ list = list.filter(c => c.status === filter); }

      if(!Array.isArray(list) || list.length===0){
        body.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No campaigns</td></tr>`;
        document.getElementById('count-active').textContent = 0;
        document.getElementById('count-paused').textContent = 0;
        document.getElementById('count-draft').textContent  = 0;
        return;
      }

      document.getElementById('count-active').textContent = list.filter(c=>c.status==='running').length;
      document.getElementById('count-paused').textContent = list.filter(c=>c.status==='paused').length;
      document.getElementById('count-draft').textContent  = list.filter(c=>c.status==='draft').length;

      body.innerHTML = list.map(c=>`
        <tr>
          <td><a href="/campaign/${c.id}/" class="link-dark text-decoration-none">${c.name}</a></td>
          <td>${(c.objective||'').replace('_',' ')}</td>
          <td class="text-capitalize">${c.primary_channel}</td>
          <td>${badge(c.status)}</td>
          <td class="text-end">${money(c.budget_total)}</td>
          <td class="text-end"><i class="bi bi-three-dots"></i></td>
        </tr>`).join('');
    }catch(e){
      body.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load</td></tr>`;
      console.error(e);
    }
  }

  document.querySelectorAll('[data-filter]').forEach(btn=>{
    btn.addEventListener('click', ()=> loadCampaigns(btn.dataset.filter));
  });

  document.getElementById("createCampaignForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    data.start_at = new Date().toISOString();
    data.end_at   = new Date(Date.now()+7*24*3600*1000).toISOString();

    const r = await fetch(`${apiBase}/campaigns/`, {
      method: "POST",
      headers: {"Content-Type":"application/json","X-CSRFToken":csrftoken},
      body: JSON.stringify(data)
    });
    if(r.ok){
      bootstrap.Modal.getInstance(document.getElementById('createCampaignModal')).hide();
      e.target.reset();
      loadCampaigns();
    }else{
      alert(await r.text());
    }
  });

  (function renderChart(){
    const ctx = document.getElementById('perfChart');
    const labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const spend=[2100,1300,3800,2600,1700,2000,3200];
    const conv =[12,8,35,20,15,18,28];
    new Chart(ctx,{type:'line',data:{labels,
      datasets:[
        {label:'Spend ($)', data:spend, tension:.35, borderWidth:3, borderColor:'#17a8ff', backgroundColor:'rgba(23,168,255,0.1)'},
        {label:'Conversions', data:conv, tension:.35, borderWidth:3, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)'}
      ]}, options:{
        responsive:true, 
        maintainAspectRatio:false,
        interaction:{mode:'index',intersect:false},
        plugins:{
          legend:{
            position:'top'
          }
        },
        scales:{
          y:{
            beginAtZero:true,
            grid:{
              color:'rgba(0,0,0,0.1)'
            }
          },
          x:{
            grid:{
              color:'rgba(0,0,0,0.1)'
            }
          }
        }
      }});
  })();

  loadKPIs();
  loadCampaigns();
</script>
{% endblock %}
