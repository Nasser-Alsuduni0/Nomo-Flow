<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ campaign_name }} — Nomo Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>body{background:#f7f7fb}.card{border:0;box-shadow:0 6px 20px rgba(10,10,30,.06)}</style>
</head>
<body>
<nav class="navbar bg-white border-bottom sticky-top">
  <div class="container-fluid px-3">
    <a class="navbar-brand" href="/">Nomo Flow</a>
    <a class="btn btn-outline-secondary" href="/">← Back</a>
  </div>
</nav>

<div class="container-fluid px-3 px-md-4 py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">{{ campaign_name }}</h3>
      <small class="text-muted">Campaign ID: {{ campaign_id }}</small>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" id="btn-pause"><i class="bi bi-pause-fill me-1"></i>Pause</button>
      <button class="btn btn-primary" id="btn-boost"><i class="bi bi-graph-up-arrow me-1"></i>Boost Budget</button>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-3"><div class="card p-3"><div class="text-muted">Spend</div><div id="kpi-spend" class="fs-3 fw-bold">-</div></div></div>
    <div class="col-md-3"><div class="card p-3"><div class="text-muted">Conversions</div><div id="kpi-conv" class="fs-3 fw-bold">-</div></div></div>
    <div class="col-md-3"><div class="card p-3"><div class="text-muted">CPA</div><div id="kpi-cpa" class="fs-3 fw-bold">-</div></div></div>
    <div class="col-md-3"><div class="card p-3"><div class="text-muted">ROAS</div><div id="kpi-roas" class="fs-3 fw-bold">-</div></div></div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h6 class="mb-0">Performance — Last 7 Days</h6>
      <canvas id="perfChart" height="90" class="mt-3"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h6 class="mb-3">Events Log</h6>
      <div class="table-responsive">
        <table class="table">
          <thead class="table-light"><tr><th>Time</th><th>Action</th><th>Reason</th></tr></thead>
          <tbody id="tbl-events"><tr><td colspan="3" class="text-center text-muted">No events</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const apiBase = "/api/marketing";
  const campaignId = {{ campaign_id|safe }};
  function money(v){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(v||0); }

  async function loadKPIs(){
    try{
      const r = await fetch(`${apiBase}/kpis/?campaign_id=${campaignId}`);
      const d = await r.json();
      document.getElementById('kpi-spend').textContent = money(d.spend||0);
      document.getElementById('kpi-conv').textContent  = d.conversions ?? 0;
      document.getElementById('kpi-cpa').textContent   = d.cpa ?? '-';
      document.getElementById('kpi-roas').textContent  = d.roas ?? '-';
    }catch(e){ console.warn(e); }
  }

  (function renderChart(){
    const ctx = document.getElementById('perfChart');
    const labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const spend=[1200,800,3700,2500,1700,1900,3100];
    const conv =[20,12,35,22,15,16,28];
    new Chart(ctx,{type:'line',data:{labels,
      datasets:[
        {label:'Spend ($)', data:spend, tension:.35, borderWidth:3},
        {label:'Conversions', data:conv, tension:.35, borderWidth:3}
      ]}, options:{responsive:true, interaction:{mode:'index',intersect:false}}});
  })();

  document.getElementById('btn-pause').addEventListener('click', ()=>alert('Pause via provider API (mock)'));
  document.getElementById('btn-boost').addEventListener('click', ()=>alert('Increase budget via provider API (mock)'));

  loadKPIs();
</script>
</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const apiBase = "/api/marketing";

  function money(v){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(v||0); }
  function badge(status){
    if(status==="running") return '<span class="badge bg-success">Active</span>';
    if(status==="paused")  return '<span class="badge bg-danger">Paused</span>';
    if(status==="draft")   return '<span class="badge bg-secondary">Draft</span>';
    return `<span class="badge bg-light text-dark">${status||"-"}</span>`;
  }
  function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m?m.pop():'';
  }
  const csrftoken=getCookie('csrftoken');

  async function loadKPIs(){
    try{
      const r = await fetch(`${apiBase}/kpis/`);
      const d = await r.json();
      document.getElementById("kpi-spend").textContent = money(d.spend_today||0);
      document.getElementById("kpi-conv").textContent  = d.conversions ?? 0;
      document.getElementById("kpi-cpa").textContent   = d.cpa ?? "-";
      document.getElementById("kpi-roas").textContent  = d.roas ?? "-";
    }catch(e){ console.warn(e); }
  }

  async function loadCampaigns(filter=null){
    const body = document.getElementById("campaigns-body");   
    body.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Loading…</td></tr>`;

    try{
      const r = await fetch(`${apiBase}/campaigns/`);
      let list = await r.json();
      if(filter){ list = list.filter(c => c.status === filter); }

      if(!Array.isArray(list) || list.length===0){
        body.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No campaigns</td></tr>`;
        document.getElementById('count-active').textContent = 0;
        document.getElementById('count-paused').textContent = 0;
        document.getElementById('count-draft').textContent  = 0;
        return;
      }

      document.getElementById('count-active').textContent = list.filter(c=>c.status==='running').length;
      document.getElementById('count-paused').textContent = list.filter(c=>c.status==='paused').length;
      document.getElementById('count-draft').textContent  = list.filter(c=>c.status==='draft').length;

      body.innerHTML = list.map(c=>`
        <tr>
          <td><a href="/campaign/${c.id}/" class="link-dark text-decoration-none">${c.name}</a></td>
          <td>${(c.objective||'').replace('_',' ')}</td>
          <td class="text-capitalize">${c.primary_channel}</td>
          <td>${badge(c.status)}</td>
          <td class="text-end">${money(c.budget_total)}</td>
          <td class="text-end"><i class="bi bi-three-dots"></i></td>
        </tr>`).join('');
    }catch(e){
      body.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load</td></tr>`;
      console.error(e);
    }
  }

  document.querySelectorAll('[data-filter]').forEach(btn=>{
    btn.addEventListener('click', ()=> loadCampaigns(btn.dataset.filter));
  });

  document.getElementById("createCampaignForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    data.start_at = new Date().toISOString();
    data.end_at   = new Date(Date.now()+7*24*3600*1000).toISOString();

    const r = await fetch(`${apiBase}/campaigns/`, {
      method: "POST",
      headers: {"Content-Type":"application/json","X-CSRFToken":csrftoken},
      body: JSON.stringify(data)
    });
    if(r.ok){
      bootstrap.Modal.getInstance(document.getElementById('createCampaignModal')).hide();
      e.target.reset();
      loadCampaigns();
    }else{
      alert(await r.text());
    }
  });

  (function renderChart(){
    const ctx = document.getElementById('perfChart');
    const labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const spend=[2100,1300,3800,2600,1700,2000,3200];
    const conv =[12,8,35,20,15,18,28];
    new Chart(ctx,{type:'line',data:{labels,
      datasets:[
        {label:'Spend ($)', data:spend, tension:.35, borderWidth:3},
        {label:'Conversions', data:conv, tension:.35, borderWidth:3}
      ]}, options:{responsive:true, interaction:{mode:'index',intersect:false}}});
  })();

  loadKPIs();
  loadCampaigns();
</script>
</body>
</html>
