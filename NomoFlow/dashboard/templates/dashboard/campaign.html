{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}Dashboard ¬∑ Campaigns{% endblock %}
{% block header %}Campaign Management{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <!-- üîπ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold mb-0 text-primary">
      <i class="bi bi-bullseye me-2 text-danger"></i> Campaign Management
    </h4>
    <button class="btn btn-primary btn-sm shadow-sm" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
      <i class="bi bi-plus-circle me-1"></i> New Campaign
    </button>
  </div>

  <!-- üß† ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ© -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm border-0 bg-light">
        <div class="card-body">
          <div class="text-muted small">Total Campaigns</div>
          <div id="stat-total" class="fw-bold fs-5 text-dark">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm border-0 bg-light">
        <div class="card-body">
          <div class="text-muted small">Active Campaigns</div>
          <div id="stat-active" class="fw-bold fs-5 text-success">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm border-0 bg-light">
        <div class="card-body">
          <div class="text-muted small">Total Budget (SAR)</div>
          <div id="stat-budget" class="fw-bold fs-5 text-primary">SAR 0.00</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm border-0 bg-light">
        <div class="card-body">
          <div class="text-muted small">Recently Added</div>
          <div id="stat-latest" class="fw-bold fs-6 text-secondary">‚Äì</div>
        </div>
      </div>
    </div>
  </div>

  <!-- üîç ÿßŸÑŸÅŸÑÿßÿ™ÿ± ŸàÿßŸÑŸÅÿ±ÿ≤ -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-primary btn-sm" onclick="loadCampaigns()">All</button>
      <button class="btn btn-outline-success btn-sm" onclick="loadCampaigns('running')">Active</button>
      <button class="btn btn-outline-warning btn-sm" onclick="loadCampaigns('paused')">Paused</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="loadCampaigns('draft')">Draft</button>
    </div>
    <select id="sortSelect" class="form-select form-select-sm w-auto" onchange="sortCampaigns()">
      <option value="">Sort by</option>
      <option value="budget">Budget</option>
      <option value="status">Status</option>
      <option value="name">Name</option>
    </select>
  </div>

  <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ≠ŸÖŸÑÿßÿ™ -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Objective</th>
              <th>Channel</th>
              <th>Status</th>
              <th>Progress</th>
              <th class="text-end">Budget</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody id="campaigns-body">
            <tr><td colspan="7" class="text-center text-muted">Loading campaigns...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- üîπ ŸÜÿßŸÅÿ∞ÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ŸÖŸÑÿ© -->
<div class="modal fade" id="createCampaignModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Campaign</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="createCampaignForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Campaign Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Objective</label>
            <select class="form-select" name="objective" required>
              <option value="sales">Increase Sales</option>
              <option value="awareness">Brand Awareness</option>
              <option value="clearance">Clearance</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Product URL</label>
            <input type="url" class="form-control" name="product_url" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Budget (SAR)</label>
            <input type="number" class="form-control" name="budget_total" min="1" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Primary Channel</label>
            <select class="form-select" name="primary_channel">
              <option value="tiktok">TikTok</option>
              <option value="instagram">Instagram</option>
              <option value="snapchat">Snapchat</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const apiBase = "/marketing";
let campaignsCache = [];

function money(v){ 
  return new Intl.NumberFormat('en-US',{style:'currency',currency:'SAR'}).format(v||0); 
}
function badge(status){
  const map = {
    running: 'success',
    paused: 'warning',
    draft: 'secondary',
    done: 'info'
  };
  return `<span class="badge bg-${map[status]||'light'} text-dark">${status||'-'}</span>`;
}
function channelIcon(ch){
  const icons = {tiktok:"bi bi-tiktok", instagram:"bi bi-instagram", snapchat:"bi bi-camera"};
  return `<i class="${icons[ch]||'bi bi-broadcast'} me-1 text-muted"></i>${ch}`;
}

// üîπ ÿ™ŸÜÿ®ŸäŸá
function showAlert(msg,type="success"){
  const div=document.createElement("div");
  div.className=`alert alert-${type} fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
  div.style.zIndex="2000";
  div.innerHTML=msg;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),3000);
}

// üîπ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≠ŸÖŸÑÿßÿ™
async function loadCampaigns(filter=null){
  const body=document.getElementById("campaigns-body");
  body.innerHTML=`<tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>`;
  try{
    const r=await fetch(`${apiBase}/campaigns/`);
    const list=await r.json();
    campaignsCache=list;
    let filtered=filter?list.filter(c=>c.status===filter):list;

    // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
    const total=filtered.length;
    const active=filtered.filter(c=>c.status==='running').length;
    const totalBudget=filtered.reduce((s,c)=>s+parseFloat(c.budget_total||0),0);
    const latest=filtered[0]?.name || '‚Äì';
    document.getElementById("stat-total").textContent=total;
    document.getElementById("stat-active").textContent=active;
    document.getElementById("stat-budget").textContent=money(totalBudget);
    document.getElementById("stat-latest").textContent=latest;

    if(!filtered.length){
      body.innerHTML=`<tr><td colspan="7" class="text-center text-muted">No campaigns found</td></tr>`;
      return;
    }

    body.innerHTML=filtered.map(c=>`
      <tr>
        <td>${c.name}</td>
        <td>${c.objective}</td>
        <td>${channelIcon(c.primary_channel)}</td>
        <td>${badge(c.status)}</td>
        <td>
          <div class="progress" style="height:6px;">
            <div class="progress-bar bg-${c.status==='done'?'info':'success'}" style="width:${c.status==='done'?100:70}%"></div>
          </div>
        </td>
        <td class="text-end">${money(c.budget_total)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" onclick="deleteCampaign(${c.id})"><i class="bi bi-trash"></i></button>
        </td>
      </tr>
    `).join("");
  }catch(e){
    body.innerHTML=`<tr><td colspan="7" class="text-center text-danger">Failed to load campaigns</td></tr>`;
    console.error(e);
  }
}

// üîπ ŸÅÿ±ÿ≤ ÿßŸÑÿ≠ŸÖŸÑÿßÿ™
function sortCampaigns(){
  const value=document.getElementById("sortSelect").value;
  let sorted=[...campaignsCache];
  if(value==="budget") sorted.sort((a,b)=>b.budget_total-a.budget_total);
  if(value==="status") sorted.sort((a,b)=>a.status.localeCompare(b.status));
  if(value==="name") sorted.sort((a,b)=>a.name.localeCompare(b.name));
  campaignsCache=sorted;
  loadCampaigns();
}

// üîπ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ŸÖŸÑÿ©
document.getElementById("createCampaignForm").addEventListener("submit",async(e)=>{
  e.preventDefault();
  const data=Object.fromEntries(new FormData(e.target).entries());
  const r=await fetch(`${apiBase}/campaigns/`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });
  if(r.ok){
    e.target.reset();
    bootstrap.Modal.getInstance(document.getElementById('createCampaignModal')).hide();
    showAlert("‚úÖ Campaign created successfully!");
    loadCampaigns();
  }else{
    showAlert("‚ùå Failed to create campaign","danger");
  }
});

// üîπ ÿ≠ÿ∞ŸÅ ÿ≠ŸÖŸÑÿ©
async function deleteCampaign(id){
  if(!confirm("Are you sure you want to delete this campaign?")) return;
  const r=await fetch(`${apiBase}/campaigns/${id}/`,{method:"DELETE"});
  if(r.ok){
    showAlert("üóëÔ∏è Campaign deleted!");
    loadCampaigns();
  }else{
    showAlert("‚ùå Failed to delete campaign","danger");
  }
}

loadCampaigns();
</script>
{% endblock %}
