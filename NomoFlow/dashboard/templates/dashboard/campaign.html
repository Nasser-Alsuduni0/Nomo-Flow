{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}Dashboard ¬∑ Campaigns{% endblock %}
{% block header %}Campaign Management{% endblock %}

{% block content %}
<style>
  /* Campaign Page - Professional Modern Design */
  .campaign-page {
    --cp-bg: #f8f9fb;
    --cp-card: #ffffff;
    --cp-border: rgba(0, 0, 0, 0.06);
    --cp-text: #18181b;
    --cp-text-muted: #71717a;
    --cp-accent: #27272a;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .campaign-page .page-container {
    background: var(--cp-bg);
    min-height: 100vh;
    padding: 24px;
    margin: -16px;
  }

  /* Header */
  .campaign-page .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .campaign-page .page-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--cp-text);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .campaign-page .title-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f4f4f5;
    border: 1px solid var(--cp-border);
    border-radius: 10px;
    color: var(--cp-accent);
  }

  .campaign-page .btn-create {
    background: var(--cp-accent);
    color: #ffffff;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .campaign-page .btn-create:hover {
    background: #3f3f46;
    transform: translateY(-1px);
  }

  /* Stats Grid */
  .campaign-page .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  @media (max-width: 992px) {
    .campaign-page .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 576px) {
    .campaign-page .stats-grid {
      grid-template-columns: 1fr;
    }
  }

  .campaign-page .stat-card {
    background: var(--cp-card);
    border: 1px solid var(--cp-border);
    border-radius: 14px;
    padding: 20px;
    transition: all 0.2s ease;
  }

  .campaign-page .stat-card:hover {
    border-color: rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  }

  .campaign-page .stat-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--cp-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 8px;
  }

  .campaign-page .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--cp-text);
    font-variant-numeric: tabular-nums;
  }

  .campaign-page .stat-value.success {
    color: #16a34a;
  }

  .campaign-page .stat-value.muted {
    color: var(--cp-text-muted);
    font-size: 14px;
  }

  /* Filter Bar */
  .campaign-page .filter-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .campaign-page .filter-tabs {
    display: flex;
    gap: 6px;
    background: #f1f1f4;
    padding: 4px;
    border-radius: 10px;
    border: 1px solid var(--cp-border);
  }

  .campaign-page .filter-btn {
    background: transparent;
    border: 1px solid transparent;
    color: #52525b;
    font-size: 12px;
    font-weight: 600;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .campaign-page .filter-btn:hover {
    background: #e4e4e7;
    color: #18181b;
  }

  .campaign-page .filter-btn.active {
    background: #27272a;
    color: #ffffff;
    border-color: #27272a;
  }

  .campaign-page .sort-select {
    background: var(--cp-card);
    border: 1px solid var(--cp-border);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 13px;
    color: var(--cp-text);
    cursor: pointer;
    min-width: 140px;
  }

  .campaign-page .sort-select:focus {
    outline: none;
    border-color: var(--cp-accent);
  }

  /* Table Card */
  .campaign-page .table-card {
    background: var(--cp-card);
    border: 1px solid var(--cp-border);
    border-radius: 16px;
    overflow: hidden;
  }

  .campaign-page .table-wrapper {
    overflow-x: auto;
  }

  .campaign-page table {
    width: 100%;
    border-collapse: collapse;
  }

  .campaign-page thead {
    background: #fafafa;
    border-bottom: 1px solid var(--cp-border);
  }

  .campaign-page th {
    font-size: 11px;
    font-weight: 600;
    color: var(--cp-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 14px 20px;
    text-align: left;
  }

  .campaign-page th:last-child {
    text-align: right;
  }

  .campaign-page td {
    padding: 16px 20px;
    font-size: 13px;
    color: var(--cp-text);
    border-bottom: 1px solid #f4f4f5;
    vertical-align: middle;
  }

  .campaign-page tbody tr:last-child td {
    border-bottom: none;
  }

  .campaign-page tbody tr:hover {
    background: #fafbfc;
  }

  .campaign-page .campaign-name {
    font-weight: 600;
    color: var(--cp-text);
  }

  .campaign-page .campaign-objective {
    color: var(--cp-text-muted);
    font-size: 12px;
  }

  .campaign-page .channel-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #f4f4f5;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    color: var(--cp-text);
  }

  .campaign-page .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .campaign-page .status-badge.running {
    background: #dcfce7;
    color: #166534;
  }

  .campaign-page .status-badge.paused {
    background: #fef3c7;
    color: #92400e;
  }

  .campaign-page .status-badge.draft {
    background: #f4f4f5;
    color: #52525b;
  }

  .campaign-page .status-badge.done {
    background: #e0e7ff;
    color: #3730a3;
  }

  .campaign-page .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
  }

  .campaign-page .progress-bar-wrapper {
    width: 100px;
    height: 6px;
    background: #f4f4f5;
    border-radius: 3px;
    overflow: hidden;
  }

  .campaign-page .progress-bar-fill {
    height: 100%;
    background: #27272a;
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  .campaign-page .budget-value {
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    text-align: right;
  }

  .campaign-page .actions-cell {
    text-align: right;
  }

  .campaign-page .btn-delete {
    background: transparent;
    border: 1px solid #fecaca;
    color: #ef4444;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .campaign-page .btn-delete:hover {
    background: #fef2f2;
    border-color: #ef4444;
  }

  .campaign-page .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--cp-text-muted);
  }

  .campaign-page .empty-state i {
    font-size: 40px;
    opacity: 0.3;
    margin-bottom: 16px;
  }

  /* Modal Styling */
  .campaign-page .modal-content {
    border: none;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .campaign-page .modal-header {
    border-bottom: 1px solid var(--cp-border);
    padding: 20px 24px;
  }

  .campaign-page .modal-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--cp-text);
  }

  .campaign-page .modal-body {
    padding: 24px;
  }

  .campaign-page .form-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--cp-text);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 8px;
  }

  .campaign-page .form-control,
  .campaign-page .form-select {
    border: 1px solid #e4e4e7;
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 14px;
    transition: all 0.2s ease;
  }

  .campaign-page .form-control:focus,
  .campaign-page .form-select:focus {
    border-color: var(--cp-accent);
    box-shadow: 0 0 0 3px rgba(39, 39, 42, 0.1);
  }

  .campaign-page .modal-footer {
    border-top: 1px solid var(--cp-border);
    padding: 16px 24px;
  }

  .campaign-page .btn-cancel {
    background: #f4f4f5;
    border: none;
    color: var(--cp-text);
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .campaign-page .btn-cancel:hover {
    background: #e4e4e7;
  }

  .campaign-page .btn-submit {
    background: var(--cp-accent);
    border: none;
    color: #ffffff;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .campaign-page .btn-submit:hover {
    background: #3f3f46;
  }
</style>

<div class="campaign-page">
  <div class="page-container">

    <!-- Header -->
    <div class="page-header">
      <h1 class="page-title">
        <span class="title-icon"><i class="bi bi-megaphone"></i></span>
        Campaign Management
      </h1>
      <button class="btn-create" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
        <i class="bi bi-plus"></i>
        New Campaign
      </button>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Campaigns</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Campaigns</div>
        <div class="stat-value success" id="stat-active">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Budget</div>
        <div class="stat-value" id="stat-budget">SAR 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Recently Added</div>
        <div class="stat-value muted" id="stat-latest">‚Äì</div>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-tabs">
        <button class="filter-btn active" onclick="filterCampaigns(this, null)">All</button>
        <button class="filter-btn" onclick="filterCampaigns(this, 'running')">Active</button>
        <button class="filter-btn" onclick="filterCampaigns(this, 'paused')">Paused</button>
        <button class="filter-btn" onclick="filterCampaigns(this, 'draft')">Draft</button>
      </div>
      <select class="sort-select" id="sortSelect" onchange="sortCampaigns()">
        <option value="">Sort by...</option>
        <option value="budget">Budget (High-Low)</option>
        <option value="status">Status</option>
        <option value="name">Name (A-Z)</option>
      </select>
    </div>

    <!-- Table -->
    <div class="table-card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Campaign</th>
              <th>Channel</th>
              <th>Status</th>
              <th>Progress</th>
              <th>Budget</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="campaigns-body">
            <tr>
              <td colspan="6" class="empty-state">
                <i class="bi bi-arrow-repeat"></i>
                <div>Loading campaigns...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Create Campaign Modal -->
<div class="modal fade campaign-page" id="createCampaignModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Campaign</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="createCampaignForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Campaign Name</label>
            <input type="text" class="form-control" name="name" placeholder="Enter campaign name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Objective</label>
            <select class="form-select" name="objective" required>
              <option value="sales">Increase Sales</option>
              <option value="awareness">Brand Awareness</option>
              <option value="clearance">Clearance</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Product URL</label>
            <input type="url" class="form-control" name="product_url" placeholder="https://" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Budget (SAR)</label>
            <input type="number" class="form-control" name="budget_total" min="1" placeholder="0.00" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Primary Channel</label>
            <select class="form-select" name="primary_channel">
              <option value="tiktok">TikTok</option>
              <option value="instagram">Instagram</option>
              <option value="snapchat">Snapchat</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn-submit">Create Campaign</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const apiBase = "/marketing";
  let campaignsCache = [];
  let currentFilter = null;

  function money(v) {
    return new Intl.NumberFormat('en-SA', { style: 'currency', currency: 'SAR' }).format(v || 0);
  }

  function getStatusBadge(status) {
    return `<span class="status-badge ${status}"><span class="status-dot"></span>${status || 'unknown'}</span>`;
  }

  function getChannelTag(channel) {
    const icons = { tiktok: "bi-tiktok", instagram: "bi-instagram", snapchat: "bi-camera" };
    return `<span class="channel-tag"><i class="bi ${icons[channel] || 'bi-broadcast'}"></i>${channel}</span>`;
  }

  function showAlert(msg, type = "success") {
    const div = document.createElement("div");
    div.className = `alert alert-${type} fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow-lg`;
    div.style.cssText = "z-index:2000;border-radius:12px;font-size:14px;";
    div.innerHTML = msg;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }

  function filterCampaigns(btn, filter) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = filter;
    loadCampaigns(filter);
  }

  async function loadCampaigns(filter = null) {
    const body = document.getElementById("campaigns-body");
    body.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="bi bi-arrow-repeat"></i><div>Loading...</div></td></tr>`;

    try {
      const r = await fetch(`${apiBase}/campaigns/`);
      const list = await r.json();
      campaignsCache = list;
      let filtered = filter ? list.filter(c => c.status === filter) : list;

      // Update stats
      const total = filtered.length;
      const active = filtered.filter(c => c.status === 'running').length;
      const totalBudget = filtered.reduce((s, c) => s + parseFloat(c.budget_total || 0), 0);
      const latest = filtered[0]?.name || '‚Äì';

      document.getElementById("stat-total").textContent = total;
      document.getElementById("stat-active").textContent = active;
      document.getElementById("stat-budget").textContent = money(totalBudget);
      document.getElementById("stat-latest").textContent = latest;

      if (!filtered.length) {
        body.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="bi bi-inbox"></i><div>No campaigns found</div></td></tr>`;
        return;
      }

      body.innerHTML = filtered.map(c => `
      <tr>
        <td>
          <div class="campaign-name">${c.name}</div>
          <div class="campaign-objective">${c.objective}</div>
        </td>
        <td>${getChannelTag(c.primary_channel)}</td>
        <td>${getStatusBadge(c.status)}</td>
        <td>
          <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" style="width:${c.status === 'done' ? 100 : c.status === 'running' ? 70 : 30}%"></div>
          </div>
        </td>
        <td class="budget-value">${money(c.budget_total)}</td>
        <td class="actions-cell">
          <button class="btn-delete" onclick="deleteCampaign(${c.id})" title="Delete">
            <i class="bi bi-trash3"></i>
          </button>
        </td>
      </tr>
    `).join("");

    } catch (e) {
      body.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="bi bi-exclamation-triangle"></i><div>Failed to load campaigns</div></td></tr>`;
      console.error(e);
    }
  }

  function sortCampaigns() {
    const value = document.getElementById("sortSelect").value;
    let sorted = [...campaignsCache];
    if (value === "budget") sorted.sort((a, b) => b.budget_total - a.budget_total);
    if (value === "status") sorted.sort((a, b) => a.status.localeCompare(b.status));
    if (value === "name") sorted.sort((a, b) => a.name.localeCompare(b.name));
    campaignsCache = sorted;

    const body = document.getElementById("campaigns-body");
    let filtered = currentFilter ? sorted.filter(c => c.status === currentFilter) : sorted;

    if (!filtered.length) {
      body.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="bi bi-inbox"></i><div>No campaigns found</div></td></tr>`;
      return;
    }

    body.innerHTML = filtered.map(c => `
    <tr>
      <td>
        <div class="campaign-name">${c.name}</div>
        <div class="campaign-objective">${c.objective}</div>
      </td>
      <td>${getChannelTag(c.primary_channel)}</td>
      <td>${getStatusBadge(c.status)}</td>
      <td>
        <div class="progress-bar-wrapper">
          <div class="progress-bar-fill" style="width:${c.status === 'done' ? 100 : c.status === 'running' ? 70 : 30}%"></div>
        </div>
      </td>
      <td class="budget-value">${money(c.budget_total)}</td>
      <td class="actions-cell">
        <button class="btn-delete" onclick="deleteCampaign(${c.id})" title="Delete">
          <i class="bi bi-trash3"></i>
        </button>
      </td>
    </tr>
  `).join("");
  }

  document.getElementById("createCampaignForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const r = await fetch(`${apiBase}/campaigns/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    if (r.ok) {
      e.target.reset();
      bootstrap.Modal.getInstance(document.getElementById('createCampaignModal')).hide();
      showAlert("‚úÖ Campaign created successfully!");
      loadCampaigns(currentFilter);
    } else {
      showAlert("‚ùå Failed to create campaign", "danger");
    }
  });

  async function deleteCampaign(id) {
    if (!confirm("Are you sure you want to delete this campaign?")) return;
    const r = await fetch(`${apiBase}/campaigns/${id}/`, { method: "DELETE" });
    if (r.ok) {
      showAlert("üóëÔ∏è Campaign deleted!");
      loadCampaigns(currentFilter);
    } else {
      showAlert("‚ùå Failed to delete campaign", "danger");
    }
  }

  loadCampaigns();
</script>
{% endblock %}