{% extends 'dashboard/base.html' %}
{% block title %}Dashboard Â· Notifications{% endblock %}
{% block header %}Notifications{% endblock %}
{% block content %}

<div class="alert alert-info mb-3" role="alert">
  <i class="bi bi-shop me-2"></i>
  <strong>Current Store:</strong> {{ merchant.name }} ({{ merchant.salla_merchant_id }})
</div>

<div class="row">
  <!-- Create Notification Form -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Create New Notification</h6>
      </div>
      <div class="card-body">
        <form method="post" id="notificationForm">
          {% csrf_token %}
          
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Title</label>
              {{ form.title }}
            </div>
            
            <div class="col-12">
              <label class="form-label">Message</label>
              {{ form.message }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Background Color</label>
              {{ form.background_color }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Text Color</label>
              {{ form.text_color }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Button Text (optional)</label>
              {{ form.button_text }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Button URL (optional)</label>
              {{ form.button_url }}
            </div>
            
            <div class="col-12">
              <div class="form-check">
                {{ form.is_active }}
                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                  Active (show on store)
                </label>
              </div>
            </div>
            
            <div class="col-12">
              <button type="button" class="btn btn-outline-primary me-2" id="previewBtn">
                <i class="bi bi-eye me-1"></i>Preview
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Create Notification
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notifications List -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Your Notifications</h6>
      </div>
      <div class="card-body">
        {% if notifications %}
          <div class="list-group list-group-flush">
            {% for notification in notifications %}
              <div class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                  <div class="fw-bold">{{ notification.title }}</div>
                  <small class="text-muted">{{ notification.message|truncatechars:50 }}</small>
                  <div class="mt-1">
                    <span class="badge bg-{{ notification.notification_type|default:'primary' }} me-1">
                      {{ notification.get_notification_type_display }}
                    </span>
                    <span class="badge bg-{{ notification.is_active|yesno:'success,secondary' }}">
                      {{ notification.is_active|yesno:'Active,Inactive' }}
                    </span>
                  </div>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary btn-sm edit-btn" data-id="{{ notification.id }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-outline-{{ notification.is_active|yesno:'warning,success' }} btn-sm toggle-btn" 
                          data-id="{{ notification.id }}" 
                          data-active="{{ notification.is_active|yesno:'true,false' }}">
                    <i class="bi bi-{{ notification.is_active|yesno:'pause,play' }}"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm delete-btn" data-id="{{ notification.id }}">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-bell-slash fs-1"></i>
            <p class="mt-2">No notifications created yet</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Notification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" id="edit_title" name="title" required>
            </div>
            
            <div class="col-12">
              <label class="form-label">Message</label>
              <textarea class="form-control" id="edit_message" name="message" rows="3" required></textarea>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Background Color</label>
              <input type="color" class="form-control" id="edit_background_color" name="background_color" value="#17a8ff">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Text Color</label>
              <input type="color" class="form-control" id="edit_text_color" name="text_color" value="#ffffff">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Button Text (optional)</label>
              <input type="text" class="form-control" id="edit_button_text" name="button_text" placeholder="e.g., Learn More, Shop Now">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Button URL (optional)</label>
              <input type="url" class="form-control" id="edit_button_url" name="button_url" placeholder="https://example.com">
            </div>
            
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active" checked>
                <label class="form-check-label" for="edit_is_active">
                  Active (show on store)
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const editModal = new bootstrap.Modal(document.getElementById('editModal'));
  let currentEditId = null;
  
  // Edit notification functionality
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      currentEditId = id;
      
      // Fetch notification data
      fetch(`/notifications/edit/${id}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const notification = data.notification;
          
          // Populate edit form
          document.getElementById('edit_title').value = notification.title;
          document.getElementById('edit_message').value = notification.message;
          document.getElementById('edit_background_color').value = notification.background_color;
          document.getElementById('edit_text_color').value = notification.text_color;
          document.getElementById('edit_button_text').value = notification.button_text || '';
          document.getElementById('edit_button_url').value = notification.button_url || '';
          document.getElementById('edit_is_active').checked = notification.is_active;
          
          editModal.show();
        }
      });
    });
  });
  
  // Save edit functionality
  document.getElementById('saveEditBtn').addEventListener('click', function() {
    if (!currentEditId) return;
    
    const formData = new FormData(document.getElementById('editForm'));
    
    fetch(`/notifications/edit/${currentEditId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: formData,
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        editModal.hide();
        location.reload();
      } else {
        alert('Error updating notification: ' + (data.errors || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating notification');
    });
  });
  
  // Toggle notification status
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      
      fetch(`/notifications/toggle/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        }
      });
    });
  });
  
  // Delete notification
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      if (confirm('Are you sure you want to delete this notification?')) {
        const id = this.dataset.id;
        console.log('Attempting to delete notification ID:', id);
        
        fetch(`/notifications/delete/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
          },
        })
        .then(response => {
          console.log('Delete response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Delete response data:', data);
          if (data.success) {
            alert('Notification deleted successfully!');
            location.reload();
          } else {
            alert('Error deleting notification: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Delete error:', error);
          alert('Error deleting notification: ' + error.message);
        });
      }
    });
  });
  
  // Preview notification functionality
  const previewBtn = document.getElementById('previewBtn');
  if (previewBtn) {
    previewBtn.addEventListener('click', function() {
      // Get form values
      const title = document.getElementById('id_title')?.value || 'Notification Title';
      const message = document.getElementById('id_message')?.value || 'Your notification message will appear here...';
      const bgColor = document.getElementById('id_background_color')?.value || '#ffffff';
      const textColor = document.getElementById('id_text_color')?.value || '#333333';
      const buttonText = document.getElementById('id_button_text')?.value || '';
      const buttonUrl = document.getElementById('id_button_url')?.value || '';
      
      // Create preview notification
      showPreviewNotification(title, message, bgColor, textColor, buttonText, buttonUrl);
    });
  }
  
  function showPreviewNotification(title, message, bgColor, textColor, buttonText, buttonUrl) {
    // Remove existing preview if any
    const existingPreview = document.getElementById('notificationPreview');
    if (existingPreview) {
      existingPreview.remove();
    }
    
    // Create wrapper
    const wrap = document.createElement('div');
    wrap.id = 'notificationPreview';
    wrap.style.position = 'fixed';
    wrap.style.bottom = '20px';
    wrap.style.left = '20px';
    wrap.style.zIndex = '999999';
    wrap.style.opacity = '0';
    wrap.style.transform = 'translateY(20px)';
    wrap.style.transition = 'all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
    
    // Create card
    const card = document.createElement('div');
    card.style.maxWidth = '380px';
    card.style.minWidth = '300px';
    card.style.background = bgColor;
    card.style.color = textColor;
    card.style.borderRadius = '16px';
    card.style.boxShadow = '0 20px 60px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.05)';
    card.style.padding = '20px 24px';
    card.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
    card.style.position = 'relative';
    card.style.backdropFilter = 'blur(10px)';
    card.style.overflow = 'hidden';
    
    // Add decorative accent bar
    const accent = document.createElement('div');
    accent.style.position = 'absolute';
    accent.style.top = '0';
    accent.style.left = '0';
    accent.style.right = '0';
    accent.style.height = '4px';
    accent.style.background = 'linear-gradient(90deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0.4) 100%)';
    card.appendChild(accent);
    
    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '16px';
    closeBtn.style.right = '16px';
    closeBtn.style.background = 'rgba(0,0,0,0.1)';
    closeBtn.style.border = 'none';
    closeBtn.style.borderRadius = '50%';
    closeBtn.style.width = '32px';
    closeBtn.style.height = '32px';
    closeBtn.style.display = 'flex';
    closeBtn.style.alignItems = 'center';
    closeBtn.style.justifyContent = 'center';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.color = textColor;
    closeBtn.style.transition = 'all 0.2s ease';
    closeBtn.style.opacity = '0.6';
    closeBtn.style.padding = '0';
    
    closeBtn.onmouseover = function(){
      this.style.opacity = '1';
      this.style.background = 'rgba(0,0,0,0.2)';
      this.style.transform = 'scale(1.1)';
    };
    closeBtn.onmouseout = function(){
      this.style.opacity = '0.6';
      this.style.background = 'rgba(0,0,0,0.1)';
      this.style.transform = 'scale(1)';
    };
    closeBtn.onclick = function(){
      wrap.style.opacity = '0';
      wrap.style.transform = 'translateY(20px) scale(0.95)';
      setTimeout(function(){ 
        try{ wrap.remove(); }catch(e){} 
      }, 300);
    };
    card.appendChild(closeBtn);
    
    // Content container with flex layout for icon and text
    const content = document.createElement('div');
    content.style.display = 'flex';
    content.style.flexDirection = 'row';
    content.style.alignItems = 'flex-start';
    content.style.gap = '16px';
    content.style.paddingRight = '32px';
    content.style.direction = 'ltr'; // Force LTR for flex layout to keep icon on left
    
    // Notification icon on the left
    const iconContainer = document.createElement('div');
    iconContainer.style.flexShrink = '0';
    iconContainer.style.width = '48px';
    iconContainer.style.height = '48px';
    iconContainer.style.display = 'flex';
    iconContainer.style.alignItems = 'center';
    iconContainer.style.justifyContent = 'center';
    iconContainer.style.background = 'rgba(0,0,0,0.05)';
    iconContainer.style.borderRadius = '12px';
    iconContainer.innerHTML = '<svg width="28" height="28" viewBox="0 0 1800 1800" fill="currentColor" style="opacity:0.8"><path d="M1555.292,1240.33c-11.603-18.885-24.035-39.138-36.538-60.862c-1.408-5.24-4.108-9.945-7.79-13.722c-49.513-88.479-97.741-200.637-97.741-344.862c0-339.747-187.438-622.592-438.45-681.168c7.458-12.796,11.813-27.633,11.813-43.511c0-47.816-38.768-86.576-86.583-86.576c-47.813,0-86.581,38.759-86.581,86.576c0,15.878,4.35,30.715,11.813,43.511c-251.011,58.576-438.455,341.421-438.455,681.168c0,188.204-82.117,321.858-142.074,419.446c-47.275,76.945-81.431,132.54-53.413,182.688c34.706,62.133,150.24,84.154,527.356,89.08c-11.577,25.247-18.085,53.287-18.085,82.834c0,109.974,89.466,199.439,199.438,199.439c109.971,0,199.432-89.466,199.432-199.439c0-29.547-6.505-57.587-18.09-82.834c377.126-4.926,492.65-26.947,527.361-89.08C1636.728,1372.87,1602.566,1317.275,1555.292,1240.33z M900.002,1731.698c-75.415,0-136.767-61.352-136.767-136.767c0-30.793,10.234-59.236,27.477-82.121c34.47,0.25,70.82,0.385,109.26,0.424c0.021,0,0.039,0,0.061,0c38.438-0.039,74.783-0.174,109.26-0.424c17.231,22.885,27.471,51.328,27.471,82.121C1036.763,1670.347,975.412,1731.698,900.002,1731.698z"/></svg>';
    content.appendChild(iconContainer);
    
    // Text container on the right
    const textContainer = document.createElement('div');
    textContainer.style.flex = '1';
    textContainer.style.minWidth = '0';
    textContainer.style.textAlign = 'right'; // Align text to the right
    textContainer.style.direction = 'rtl'; // RTL text direction
    
    // Truncate title to 50 characters
    const titleText = title.length > 50 ? title.substring(0, 50) + '...' : title;
    
    // Title
    const titleDiv = document.createElement('div');
    titleDiv.style.fontWeight = '700';
    titleDiv.style.fontSize = '18px';
    titleDiv.style.marginBottom = '8px';
    titleDiv.style.lineHeight = '1.4';
    titleDiv.style.letterSpacing = '-0.02em';
    titleDiv.style.wordWrap = 'break-word';
    titleDiv.style.overflowWrap = 'break-word';
    titleDiv.textContent = titleText;
    textContainer.appendChild(titleDiv);
    
    // Truncate message to 120 characters
    const messageText = message.length > 120 ? message.substring(0, 120) + '...' : message;
    
    // Message
    const messageDiv = document.createElement('div');
    messageDiv.style.fontWeight = '400';
    messageDiv.style.fontSize = '15px';
    messageDiv.style.lineHeight = '1.6';
    messageDiv.style.opacity = '0.9';
    messageDiv.style.wordWrap = 'break-word';
    messageDiv.style.overflowWrap = 'break-word';
    messageDiv.textContent = messageText;
    textContainer.appendChild(messageDiv);
    
    content.appendChild(textContainer);
    
    // Button (if provided)
    if (buttonText && buttonUrl) {
      const btnLink = document.createElement('a');
      btnLink.href = buttonUrl;
      btnLink.target = '_blank';
      btnLink.rel = 'noopener noreferrer';
      btnLink.style.display = 'inline-flex';
      btnLink.style.alignItems = 'center';
      btnLink.style.gap = '6px';
      btnLink.style.marginTop = '16px';
      btnLink.style.padding = '10px 20px';
      btnLink.style.fontWeight = '600';
      btnLink.style.fontSize = '14px';
      btnLink.style.background = 'rgba(255,255,255,0.95)';
      btnLink.style.color = bgColor;
      btnLink.style.borderRadius = '10px';
      btnLink.style.textDecoration = 'none';
      btnLink.style.transition = 'all 0.2s ease';
      btnLink.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      btnLink.innerHTML = buttonText + ' <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>';
      
      btnLink.onmouseover = function(){
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.2)';
      };
      btnLink.onmouseout = function(){
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      };
      
      textContainer.appendChild(btnLink);
    }
    
    card.appendChild(content);
    wrap.appendChild(card);
    document.body.appendChild(wrap);
    
    // Animate in
    setTimeout(function(){ 
      wrap.style.opacity = '1';
      wrap.style.transform = 'translateY(0)';
    }, 10);
    
    // Preview notification stays visible until closed by user (no auto-close)
  }
});
</script>

{% endblock %}
