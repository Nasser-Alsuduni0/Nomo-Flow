{% extends 'dashboard/base.html' %}
{% block title %}Dashboard Â· Notifications{% endblock %}
{% block header %}Notifications{% endblock %}
{% block content %}

<div class="row">
  <!-- Create Notification Form -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Create New Notification</h6>
      </div>
      <div class="card-body">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}

        <form method="post" id="notificationForm">
          {% csrf_token %}
          
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Title</label>
              {{ form.title }}
            </div>
            
            <div class="col-12">
              <label class="form-label">Message</label>
              {{ form.message }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Type</label>
              {{ form.notification_type }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Position</label>
              {{ form.position }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Show Delay (seconds)</label>
              {{ form.show_delay }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Auto Close Delay (seconds)</label>
              {{ form.auto_close_delay }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Background Color</label>
              {{ form.background_color }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Text Color</label>
              {{ form.text_color }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Button Text (optional)</label>
              {{ form.button_text }}
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Button URL (optional)</label>
              {{ form.button_url }}
            </div>
            
            <div class="col-12">
              <label class="form-label">Target Pages (optional)</label>
              {{ form.target_pages }}
              <div class="form-text">Leave empty to show on all pages. Use: home, products, cart</div>
            </div>
            
            <div class="col-12">
              <div class="form-check">
                {{ form.auto_close }}
                <label class="form-check-label" for="{{ form.auto_close.id_for_label }}">
                  Auto close notification
                </label>
              </div>
            </div>
            
            <div class="col-12">
              <div class="form-check">
                {{ form.is_active }}
                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                  Active (show on store)
                </label>
              </div>
            </div>
            
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Create Notification
              </button>
              <button type="button" class="btn btn-outline-secondary ms-2" id="previewBtn">
                <i class="bi bi-eye me-1"></i>Preview
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notifications List -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Your Notifications</h6>
      </div>
      <div class="card-body">
        {% if notifications %}
          <div class="list-group list-group-flush">
            {% for notification in notifications %}
              <div class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                  <div class="fw-bold">{{ notification.title }}</div>
                  <small class="text-muted">{{ notification.message|truncatechars:50 }}</small>
                  <div class="mt-1">
                    <span class="badge bg-{{ notification.notification_type|default:'primary' }} me-1">
                      {{ notification.get_notification_type_display }}
                    </span>
                    <span class="badge bg-{{ notification.is_active|yesno:'success,secondary' }}">
                      {{ notification.is_active|yesno:'Active,Inactive' }}
                    </span>
                  </div>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-{{ notification.is_active|yesno:'warning,success' }} btn-sm toggle-btn" 
                          data-id="{{ notification.id }}" 
                          data-active="{{ notification.is_active|yesno:'true,false' }}">
                    <i class="bi bi-{{ notification.is_active|yesno:'pause,play' }}"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm delete-btn" data-id="{{ notification.id }}">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-bell-slash fs-1"></i>
            <p class="mt-2">No notifications created yet</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Notification Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="position-relative" style="height: 400px; background: #f8f9fa; border-radius: 8px;">
          <div id="previewNotification" class="position-absolute" style="display: none;">
            <div class="card shadow" style="max-width: 300px;">
              <div class="card-body">
                <h6 id="previewTitle" class="card-title"></h6>
                <p id="previewMessage" class="card-text"></p>
                <button id="previewButton" class="btn btn-sm" style="display: none;"></button>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <button type="button" class="btn btn-primary" id="showPreview">Show Preview</button>
          <button type="button" class="btn btn-secondary" id="hidePreview">Hide Preview</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Preview functionality
  const previewBtn = document.getElementById('previewBtn');
  const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
  const showPreviewBtn = document.getElementById('showPreview');
  const hidePreviewBtn = document.getElementById('hidePreview');
  const previewNotification = document.getElementById('previewNotification');
  
  previewBtn.addEventListener('click', function() {
    updatePreview();
    previewModal.show();
  });
  
  showPreviewBtn.addEventListener('click', function() {
    updatePreview();
    previewNotification.style.display = 'block';
  });
  
  hidePreviewBtn.addEventListener('click', function() {
    previewNotification.style.display = 'none';
  });
  
  function updatePreview() {
    const title = document.getElementById('id_title').value || 'Sample Title';
    const message = document.getElementById('id_message').value || 'Sample message content';
    const bgColor = document.getElementById('id_background_color').value || '#17a8ff';
    const textColor = document.getElementById('id_text_color').value || '#ffffff';
    const buttonText = document.getElementById('id_button_text').value;
    const position = document.getElementById('id_position').value || 'top-right';
    
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewMessage').textContent = message;
    
    const card = previewNotification.querySelector('.card');
    card.style.backgroundColor = bgColor;
    card.style.color = textColor;
    
    const previewButton = document.getElementById('previewButton');
    if (buttonText) {
      previewButton.textContent = buttonText;
      previewButton.style.display = 'inline-block';
      previewButton.style.backgroundColor = textColor;
      previewButton.style.color = bgColor;
    } else {
      previewButton.style.display = 'none';
    }
    
    // Position the notification
    const positions = {
      'top-left': 'top: 20px; left: 20px;',
      'top-right': 'top: 20px; right: 20px;',
      'bottom-left': 'bottom: 20px; left: 20px;',
      'bottom-right': 'bottom: 20px; right: 20px;',
      'top-center': 'top: 20px; left: 50%; transform: translateX(-50%);',
      'bottom-center': 'bottom: 20px; left: 50%; transform: translateX(-50%);'
    };
    
    previewNotification.style.cssText = positions[position] || positions['top-right'];
  }
  
  // Toggle notification status
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const isActive = this.dataset.active === 'true';
      
      fetch(`/notifications/toggle/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        }
      });
    });
  });
  
  // Delete notification
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      if (confirm('Are you sure you want to delete this notification?')) {
        const id = this.dataset.id;
        
        fetch(`/notifications/delete/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          }
        });
      }
    });
  });
});
</script>

{% endblock %}
