{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Discount Coupons - Nomo Flow{% endblock %}

{% block extra_css %}
<style>
#couponsList {
    max-height: 700px;
    overflow-y: auto;
    padding-right: 4px;
}

#couponsList::-webkit-scrollbar {
    width: 6px;
}

#couponsList::-webkit-scrollbar-track {
    background: transparent;
}

#couponsList::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}

#couponsList::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.coupon-card {
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    background: white;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.coupon-card .card-body {
    padding: 24px;
}

.coupon-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #0ea5e9 0%, #06b6d4 100%);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
}

.coupon-card:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    transform: translateY(-4px);
    border-color: #0ea5e9;
}

.coupon-card:hover::before {
    transform: scaleX(1);
}

.coupon-code {
    font-family: 'Courier New', monospace;
    font-size: 20px;
    font-weight: 700;
    color: #0ea5e9;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    padding: 8px 16px;
    border-radius: 10px;
    display: inline-block;
    letter-spacing: 1px;
    border: 2px dashed #0ea5e9;
}

.coupon-summary {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-top: 16px;
}

.summary-item {
    display: flex;
    align-items: center;
    font-size: 14px;
    color: #475569;
    padding: 6px 12px;
    background: #f8fafc;
    border-radius: 8px;
    white-space: nowrap;
}

.summary-item i {
    color: #0ea5e9;
    font-size: 14px;
}

.toggle-details-btn {
    color: #0ea5e9;
    text-decoration: none;
    font-weight: 600;
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.toggle-details-btn:hover {
    background: #f0f9ff;
    border-color: #0ea5e9;
    color: #0284c7;
}

.toggle-details-btn i {
    transition: transform 0.3s ease;
}

.toggle-details-btn.expanded i {
    transform: rotate(180deg);
}

.coupon-details-wrapper {
    overflow: hidden;
    transition: all 0.3s ease;
}

.coupon-details {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.coupon-detail-item {
    display: flex;
    flex-direction: column;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
    transition: background 0.2s ease;
}

.coupon-detail-item:hover {
    background: #f1f5f9;
}

.coupon-detail-label {
    font-size: 11px;
    color: #64748b;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 700;
}

.coupon-detail-value {
    font-size: 15px;
    font-weight: 600;
    color: #0f172a;
}

@media (max-width: 992px) {
    .coupon-details {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
    }
}

@media (max-width: 768px) {
    .coupon-summary {
        gap: 8px;
    }
    
    .summary-item {
        font-size: 13px;
        padding: 5px 10px;
    }
}

@media (max-width: 576px) {
    .coupon-code {
        font-size: 16px;
        padding: 6px 12px;
    }
    
    .coupon-summary {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
    }
    
    .summary-item {
        width: 100%;
    }
    
    .coupon-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .coupon-card .card-body {
        padding: 16px;
    }
    
    .toggle-details-btn {
        font-size: 13px;
    }
}

/* Custom status labels - no Bootstrap classes */
.status-label {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    line-height: 1.4;
    text-align: center;
    white-space: nowrap;
}

.status-active {
    background: #d1fae5;
    color: #065f46;
}

.status-inactive {
    background: #fee2e2;
    color: #991b1b;
}

.status-percent {
    background: #dbeafe;
    color: #1e40af;
}

.status-fixed {
    background: #d1fae5;
    color: #065f46;
}

        .card {
            border-radius: 12px;
            margin-bottom: 24px;
            border: none;
        }

        .card:hover {
            transform: none !important;
        }

        .card-title {
            color: #111827;
            font-size: 20px;
            font-weight: 700;
        }

.btn-delete {
    background: #fee2e2;
    color: #991b1b;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-delete:hover {
    background: #fecaca;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 mb-1">Discount Coupons</h1>
            <p class="text-muted">Create and manage discount coupons for your customers</p>
        </div>
    </div>

    <!-- Alert container for JavaScript alerts -->
    <div id="alertContainer"></div>

    <div class="row">
        <!-- Create New Coupon Form -->
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-4"><i class="bi bi-plus-circle me-2"></i>Create New Coupon</h5>
                    <form method="post" id="couponForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.code.id_for_label }}" class="form-label">{{ form.code.label }}</label>
                        {{ form.code }}
                        {% if form.code.errors %}
                        <div class="text-danger mt-1">{{ form.code.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.discount_kind.id_for_label }}" class="form-label">{{ form.discount_kind.label }}</label>
                        {{ form.discount_kind }}
                        {% if form.discount_kind.errors %}
                        <div class="text-danger mt-1">{{ form.discount_kind.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.amount.id_for_label }}" class="form-label">{{ form.amount.label }}</label>
                        <div class="input-group">
                            {{ form.amount }}
                            <span class="input-group-text">%</span>
                        </div>
                        {% if form.amount.errors %}
                        <div class="text-danger mt-1">{{ form.amount.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.max_discount_amount.id_for_label }}" class="form-label">{{ form.max_discount_amount.label }}</label>
                        <div class="input-group">
                            {{ form.max_discount_amount }}
                            <span class="input-group-text">SAR</span>
                        </div>
                        {% if form.max_discount_amount.errors %}
                        <div class="text-danger mt-1">{{ form.max_discount_amount.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.start_date.id_for_label }}" class="form-label">{{ form.start_date.label }}</label>
                            {{ form.start_date }}
                            {% if form.start_date.errors %}
                            <div class="text-danger mt-1">{{ form.start_date.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.expires_at.id_for_label }}" class="form-label">{{ form.expires_at.label }}</label>
                            {{ form.expires_at }}
                            {% if form.expires_at.errors %}
                            <div class="text-danger mt-1">{{ form.expires_at.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.free_shipping }}
                            <label class="form-check-label" for="{{ form.free_shipping.id_for_label }}">
                                {{ form.free_shipping.label }}
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.exclude_discounted }}
                            <label class="form-check-label" for="{{ form.exclude_discounted.id_for_label }}">
                                {{ form.exclude_discounted.label }}
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.min_cart.id_for_label }}" class="form-label">{{ form.min_cart.label }}</label>
                        <div class="input-group">
                            {{ form.min_cart }}
                            <span class="input-group-text">SAR</span>
                        </div>
                        <small class="text-muted">Minimum cart value excluding tax</small>
                        {% if form.min_cart.errors %}
                        <div class="text-danger mt-1">{{ form.min_cart.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.max_uses.id_for_label }}" class="form-label">{{ form.max_uses.label }}</label>
                            {{ form.max_uses }}
                            {% if form.max_uses.errors %}
                            <div class="text-danger mt-1">{{ form.max_uses.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.per_customer_limit.id_for_label }}" class="form-label">{{ form.per_customer_limit.label }}</label>
                            {{ form.per_customer_limit }}
                            {% if form.per_customer_limit.errors %}
                            <div class="text-danger mt-1">{{ form.per_customer_limit.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors.0 }}
                    </div>
                    {% endif %}

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus-circle me-1"></i>Create Coupon
                    </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Coupons List -->
        <div class="col-lg-7">
            <h5 class="mb-4"><i class="bi bi-ticket-perforated me-2"></i>Current Coupons</h5>
            
            {% if coupons %}
            <div id="couponsList" class="row">
                {% for coupon in coupons %}
                <div class="col-12 mb-3">
                    <div class="coupon-card card shadow-sm" data-coupon-id="{{ coupon.id }}">
                        <div class="card-body">
                            <!-- Header: Code and Actions -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="coupon-code">{{ coupon.code }}</div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editCoupon({{ coupon.id }})" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-{{ coupon.is_active|yesno:'warning,success' }} btn-sm" onclick="toggleCoupon({{ coupon.id }})" title="Toggle Status">
                                        <i class="bi bi-{{ coupon.is_active|yesno:'pause,play' }}"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCoupon({{ coupon.id }}, '{{ coupon.code }}')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Summary -->
                            <div class="coupon-summary">
                                <span class="status-label {% if coupon.is_active %}status-active{% else %}status-inactive{% endif %}">
                                    {{ coupon.is_active|yesno:'Active,Inactive' }}
                                </span>
                                <div class="summary-item">
                                    <i class="bi bi-tag-fill me-1"></i>
                                    <strong>{{ coupon.amount }}{% if coupon.discount_kind == 'percent' %}%{% else %} SAR{% endif %}</strong> OFF
                                </div>
                                {% if coupon.min_cart %}
                                <div class="summary-item">
                                    <i class="bi bi-cart3 me-1"></i>
                                    Min: {{ coupon.min_cart }} SAR
                                </div>
                                {% endif %}
                                {% if coupon.expires_at %}
                                <div class="summary-item">
                                    <i class="bi bi-calendar-x me-1"></i>
                                    Expires: {{ coupon.expires_at|date:"M d, Y" }}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Toggle Details Button -->
                            <button class="btn btn-link btn-sm w-100 mt-3 toggle-details-btn" type="button" onclick="toggleDetails({{ coupon.id }})">
                                <span class="details-text">View Details</span>
                                <i class="bi bi-chevron-down ms-1"></i>
                            </button>

                            <!-- Expandable Details Section -->
                            <div class="coupon-details-wrapper" id="details-{{ coupon.id }}" style="display: none;">
                                <hr class="my-3">
                                <div class="coupon-details">
                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Status</span>
                                <span class="coupon-detail-value">
                                    <span class="status-label {% if coupon.is_active %}status-active{% else %}status-inactive{% endif %}">
                                        {{ coupon.is_active|yesno:'Active,Inactive' }}
                                    </span>
                                </span>
                            </div>

                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Discount Type</span>
                                <span class="coupon-detail-value">
                                    <span class="status-label {% if coupon.discount_kind == 'percent' %}status-percent{% else %}status-fixed{% endif %}">
                                        {{ coupon.get_discount_kind_display }}
                                    </span>
                                </span>
                            </div>

                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Discount Value</span>
                                <span class="coupon-detail-value">
                                    {{ coupon.amount }}{% if coupon.discount_kind == 'percent' %}%{% else %} SAR{% endif %}
                                </span>
                            </div>

                            {% if coupon.max_discount_amount %}
                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Max Discount</span>
                                <span class="coupon-detail-value">{{ coupon.max_discount_amount }} SAR</span>
                            </div>
                            {% endif %}

                            {% if coupon.min_cart %}
                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Min Cart Value</span>
                                <span class="coupon-detail-value">{{ coupon.min_cart }} SAR</span>
                            </div>
                            {% endif %}

                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Free Shipping</span>
                                <span class="coupon-detail-value">
                                    <span class="status-label {% if coupon.free_shipping %}status-active{% else %}status-inactive{% endif %}">
                                        {% if coupon.free_shipping %}Yes{% else %}No{% endif %}
                                    </span>
                                </span>
                            </div>

                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Exclude Discounted</span>
                                <span class="coupon-detail-value">
                                    <span class="status-label {% if coupon.exclude_discounted %}status-active{% else %}status-inactive{% endif %}">
                                        {% if coupon.exclude_discounted %}Yes{% else %}No{% endif %}
                                    </span>
                                </span>
                            </div>

                            {% if coupon.start_date %}
                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Start Date</span>
                                <span class="coupon-detail-value">{{ coupon.start_date|date:"Y/m/d" }}</span>
                            </div>
                            {% endif %}

                            {% if coupon.expires_at %}
                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Expiry Date</span>
                                <span class="coupon-detail-value">{{ coupon.expires_at|date:"Y/m/d" }}</span>
                            </div>
                            {% endif %}

                            {% if coupon.max_uses %}
                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Total Uses</span>
                                <span class="coupon-detail-value">{{ coupon.max_uses }}</span>
                            </div>
                            {% endif %}

                            {% if coupon.per_customer_limit %}
                            <div class="coupon-detail-item">
                                <span class="coupon-detail-label">Per Customer</span>
                                <span class="coupon-detail-value">{{ coupon.per_customer_limit }}</span>
                            </div>
                            {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-ticket-perforated" style="font-size: 48px; color: #d1d5db;"></i>
                    <p class="text-muted mt-3">No coupons yet. Start by creating a new coupon!</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    
</div>

<script>
// Get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function copyEmbedCode() {
    const embedCode = document.getElementById('embedCode').textContent;
    const btn = document.getElementById('copyEmbedBtn');
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(embedCode).then(() => {
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-light');
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-light');
            }, 2000);
        });
    } else {
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = embedCode;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-light');
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-light');
            }, 2000);
        } catch(err) {
            console.error('Failed to copy:', err);
        }
        document.body.removeChild(textArea);
    }
}

function copySnippetCode() {
    const snippetCode = document.getElementById('snippetCode').textContent;
    const btn = event.target;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(snippetCode).then(() => {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '#0ea5e9';
            }, 2000);
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = snippetCode;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '#0ea5e9';
            }, 2000);
        } catch(err) {
            console.error('Failed to copy:', err);
        }
        document.body.removeChild(textArea);
    }
}

function toggleDetails(couponId) {
    const detailsWrapper = document.getElementById('details-' + couponId);
    const button = event.currentTarget;
    const chevronIcon = button.querySelector('i');
    const detailsText = button.querySelector('.details-text');
    
    if (detailsWrapper.style.display === 'none') {
        // Show details
        detailsWrapper.style.display = 'block';
        button.classList.add('expanded');
        detailsText.textContent = 'Hide Details';
    } else {
        // Hide details
        detailsWrapper.style.display = 'none';
        button.classList.remove('expanded');
        detailsText.textContent = 'View Details';
    }
}

function deleteCoupon(couponId, couponCode) {
    if (!confirm(`Are you sure you want to delete the coupon "${couponCode}"?`)) {
        return;
    }

    const csrftoken = getCookie('csrftoken');
    
    fetch(`{% url 'coupons:delete_coupon' 0 %}`.replace('0', couponId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Error response:', text);
                throw new Error(`Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Remove the coupon card with animation
            const card = document.querySelector(`[data-coupon-id="${couponId}"]`);
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            setTimeout(() => {
                card.remove();
                
                // Show empty state if no coupons left
                const couponsList = document.getElementById('couponsList');
                if (couponsList && couponsList.children.length === 0) {
                    location.reload();
                }
            }, 300);

            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 3000);
        } else {
            throw new Error(data.message || 'Failed to delete coupon');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('An error occurred while deleting the coupon: ' + error.message);
    });
}

function toggleCoupon(couponId) {
    const csrftoken = getCookie('csrftoken');
    
    fetch(`{% url 'coupons:toggle_coupon' 0 %}`.replace('0', couponId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error toggling coupon status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function editCoupon(couponId) {
    fetch(`{% url 'coupons:edit_coupon' 0 %}`.replace('0', couponId))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const c = data.coupon;
            document.getElementById('id_code').value = c.code;
            document.getElementById('id_discount_kind').value = c.discount_kind;
            document.getElementById('id_amount').value = c.amount;
            document.getElementById('id_max_discount_amount').value = c.max_discount_amount;
            document.getElementById('id_start_date').value = c.start_date;
            document.getElementById('id_expires_at').value = c.expires_at;
            document.getElementById('id_free_shipping').checked = c.free_shipping;
            document.getElementById('id_exclude_discounted').checked = c.exclude_discounted;
            document.getElementById('id_min_cart').value = c.min_cart;
            document.getElementById('id_max_uses').value = c.max_uses || '';
            document.getElementById('id_per_customer_limit').value = c.per_customer_limit || '';
            
            const form = document.getElementById('couponForm');
            form.setAttribute('data-edit-id', couponId);
            form.querySelector('button[type="submit"]').innerHTML = '<i class="bi bi-check-circle me-1"></i>Update Coupon';
            form.scrollIntoView({ behavior: 'smooth' });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading coupon');
    });
}

document.getElementById('couponForm').addEventListener('submit', function(e) {
    const editId = this.getAttribute('data-edit-id');
    if (editId) {
        e.preventDefault();
        const csrftoken = getCookie('csrftoken');
        const formData = new FormData(this);
        
        fetch(`{% url 'coupons:edit_coupon' 0 %}`.replace('0', editId), {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('Error: ' + JSON.stringify(data.errors));
        })
        .catch(error => alert('Error updating coupon'));
    }
});
</script>
{% endblock %}

